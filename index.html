<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Assistant Screensaver</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      /* Smooth transition for background color change */
      transition: background-color 0.5s ease;
    }
    /* Theme variations for different times of day */
    body.morning {
      background-color: #112233;
    }
    body.day {
      background-color: #121212;
    }
    body.evening {
      background-color: #222222;
    }
    /* Center alignment for header text */
    #header {
      text-align: center;
      padding-top: 5vh;
    }
    #greeting {
      font-size: 5vmin;
      font-weight: 300;
      margin: 0;
    }
    #time {
      font-size: 18vmin;
      font-weight: 100;
      margin: 0;
      line-height: 1.1;
    }
    #date {
      font-size: 4vmin;
      font-weight: 300;
      margin: 0;
    }
    /* Current weather section */
    #weather {
      max-width: 90%;
      margin: 5vh auto 0 auto;
      text-align: center;
    }
    #current-weather {
      margin-bottom: 4vh;
    }
    #current-temp {
      font-size: 6vmin;
      font-weight: 300;
    }
    #current-temp img {
      vertical-align: middle;
      /* Icon height roughly matching text size */
      height: 6vmin;
      width: auto;
      margin-right: 0.5em;
    }
    #current-desc {
      font-size: 4vmin;
      font-weight: 300;
      margin-top: 0.5vh;
    }
    /* Rain probability section */
    #rain-title {
      font-size: 3.5vmin;
      font-weight: 500;
      margin-bottom: 1vh;
    }
    #rain-hours {
      display: flex;
      justify-content: center;
      gap: 2em;
      flex-wrap: wrap;
      margin-bottom: 4vh;
    }
    .hour-block {
      text-align: center;
    }
    .hour-time {
      font-size: 0.8em;
      opacity: 0.8;
    }
    .hour-pop {
      font-size: 1.2em;
      font-weight: 500;
    }
    /* 7-day forecast table */
    #forecast {
      width: 100%;
      max-width: 600px;
      margin: 0 auto 2vh auto;
      border-collapse: collapse;
      font-size: 3vmin;
    }
    #forecast td {
      padding: 5px 0;
      vertical-align: middle;
    }
    #forecast tr:not(:last-child) {
      border-bottom: 1px solid #444;
    }
    #forecast .day-name {
      text-align: left;
      font-weight: 500;
      padding-right: 1em;
    }
    #forecast td:nth-child(2) {
      text-align: left;
    }
    #forecast td:last-child {
      text-align: right;
      font-weight: 300;
      padding-left: 1em;
    }
    .icon-forecast {
      vertical-align: middle;
      height: 24px;
      width: 24px;
      margin-right: 0.5em;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1 id="greeting"></h1>
    <div id="time"></div>
    <div id="date"></div>
  </div>
  <div id="weather">
    <div id="current-weather">
      <div id="current-temp">
        <img id="current-icon" src="" alt="" />
        <span id="current-temp-val"></span>
      </div>
      <div id="current-desc"></div>
    </div>
    <div id="rain-container">
      <div id="rain-title">Regenwahrscheinlichkeit (nächste 8h)</div>
      <div id="rain-hours"></div>
    </div>
    <table id="forecast"></table>
  </div>
  <script>
    // Update greeting, time and date
    function updateTimeDate() {
      const now = new Date();
      const hours = now.getHours();
      let greetingText;
      if (hours >= 5 && hours < 12) {
        greetingText = "Guten Morgen";
        document.body.className = "morning";
      } else if (hours >= 12 && hours < 18) {
        greetingText = "Guten Tag";
        document.body.className = "day";
      } else if (hours >= 18 && hours < 22) {
        greetingText = "Guten Abend";
        document.body.className = "evening";
      } else {
        greetingText = "Gute Nacht";
        document.body.className = "evening";
      }
      document.getElementById("greeting").textContent = greetingText;
      // Format time as HH:MM
      const timeStr = now.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
      document.getElementById("time").textContent = timeStr;
      // Format date as "Wochentag, Tag Monat Jahr"
      const dateStr = now.toLocaleDateString("de-DE", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      document.getElementById("date").textContent = dateStr;
    }
    // Fetch weather data and update sections
    function updateWeather() {
      const apiKey = "588e492fc3e89866da25c4c44bed425b";
      const lat = 53.22;
      const lon = 8.80;
      const url = `https://api.openweathermap.org/data/2.5/onecall?lat=&lon=&units=metric&lang=de&exclude=minutely,alerts&appid=`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          // Current weather
          const curr = data.current;
          const currTemp = Math.round(curr.temp);
          let currDesc = curr.weather[0].description;
          currDesc = currDesc.charAt(0).toUpperCase() + currDesc.slice(1); // capitalize first letter
          const currIcon = curr.weather[0].icon;
          document.getElementById("current-temp-val").textContent = currTemp + "°";
          document.getElementById("current-desc").textContent = currDesc;
          document.getElementById("current-icon").src = `https://openweathermap.org/img/wn/@2x.png`;
          // Rain probability for next 8 hours
          let rainHTML = "";
          for (let i = 0; i < 8 && i < data.hourly.length; i++) {
            const hourData = data.hourly[i];
            const hourDate = new Date(hourData.dt * 1000);
            const hourStr = hourDate.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
            const pop = Math.round(hourData.pop * 100);
            rainHTML += `
              <div class="hour-block">
                <div class="hour-time"></div>
                <div class="hour-pop">%</div>
              </div>`;
          }
          document.getElementById("rain-hours").innerHTML = rainHTML;
          // 7-day forecast
          let forecastHTML = "";
          for (let i = 0; i < 7 && i < data.daily.length; i++) {
            const dayData = data.daily[i];
            const date = new Date(dayData.dt * 1000);
            let weekdayLabel;
            if (i === 0) {
              weekdayLabel = "Heute";
            } else if (i === 1) {
              weekdayLabel = "Morgen";
            } else {
              weekdayLabel = date.toLocaleDateString("de-DE", { weekday: "short" });
              weekdayLabel = weekdayLabel.replace(".", "");
            }
            let description = dayData.weather[0].description;
            description = description.charAt(0).toUpperCase() + description.slice(1);
            const iconCode = dayData.weather[0].icon;
            const maxTemp = Math.round(dayData.temp.max);
            const minTemp = Math.round(dayData.temp.min);
            forecastHTML += `
              <tr>
                <td class="day-name"></td>
                <td class="forecast-desc"><img src="https://openweathermap.org/img/wn/@2x.png" class="icon-forecast" alt="" /> </td>
                <td class="temp-range">↑° ↓°</td>
              </tr>`;
          }
          document.getElementById("forecast").innerHTML = forecastHTML;
        })
        .catch(error => {
          console.error("Error fetching weather data:", error);
        });
    }
    // Initial call
    updateTimeDate();
    updateWeather();
    // Update time every minute, weather every 10 minutes
    setInterval(updateTimeDate, 60000);
    setInterval(updateWeather, 600000);
  </script>
</body>
</html>